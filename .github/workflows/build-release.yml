name: Fast Build and Direct Download

on:
  push:
    branches:
      - main
      - dev
  workflow_dispatch:

env:
  THEOS: ''
  XCODE_VERSION: '14.3.1'

jobs:
  build:
    name: Build & Upload TIPA
    runs-on: macos-13

    steps:
      - name: Setup Xcode version
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: Checkout (Shallow Clone)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Install Homebrew dependencies
        run: |
          brew install dpkg make libplist openssl@3 ldid
          echo "/usr/local/opt/make/libexec/gnubin" >> $GITHUB_PATH

      - name: Checkout Theos
        uses: actions/checkout@v4
        with:
          repository: theos/theos
          ref: master
          path: theos
          submodules: recursive

      - name: Manually Install Theos SDKs
        run: |
          cd $GITHUB_WORKSPACE/theos
          mkdir -p sdks
          curl -LO https://github.com/theos/sdks/raw/master/iPhoneOS16.2.sdk.tar.xz
          tar -xf iPhoneOS16.2.sdk.tar.xz -C sdks
          rm iPhoneOS16.2.sdk.tar.xz
          echo "THEOS=$GITHUB_WORKSPACE/theos" >> $GITHUB_ENV
          echo "SDKROOT=$GITHUB_WORKSPACE/theos/sdks/iPhoneOS16.2.sdk" >> $GITHUB_ENV

      - name: Checkout source
        uses: actions/checkout@v4
        with:
          repository: Lessica/TrollSpeed
          ref: main
          path: TrollSpeed
          submodules: recursive

      - name: Build TIPA (Fixed)
        run: |
          cd $GITHUB_WORKSPACE/TrollSpeed
          echo "ðŸš€ Starting fast build..."
          THEOS_PACKAGE_SCHEME=rootless FINALPACKAGE=1 make package

      - name: Upload TIPA to GitHub Releases
        uses: softprops/action-gh-release@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          files: TrollSpeed/packages/TrollSpeed_*.tipa
          tag_name: latest
          name: "TrollSpeed Latest Build"
          body: "Click below to download the latest TIPA file."
          draft: false
          prerelease: false
